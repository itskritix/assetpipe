---
import '../styles/brutalist.css';
import { isAdmin } from '../lib/config';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Open-source platform for company logos and brand assets' } = Astro.props;

// Get user from middleware (server-side, already validated)
const user = Astro.locals.user;
const isUserAdmin = user?.email ? isAdmin(user.email) : false;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="theme-color" content="#f5f0e8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title} | ASSETPIPE</title>
  </head>
  <body>
    <!-- BRUTAL HEADER -->
    <header class="header-brutal">
      <nav class="nav-brutal">
        <a href="/" class="logo-brutal">
          <span class="logo-text">ASSET</span>
          <span class="logo-accent">PIPE</span>
        </a>

        <div class="nav-links">
          <a href="/browse" class="nav-link">
            <span class="nav-link__number">01</span>
            <span class="nav-link__text">BROWSE</span>
          </a>
          <a href="/submit" class="nav-link">
            <span class="nav-link__number">02</span>
            <span class="nav-link__text">SUBMIT</span>
          </a>
          <a href="/docs" class="nav-link">
            <span class="nav-link__number">03</span>
            <span class="nav-link__text">API</span>
          </a>
          {isUserAdmin && (
            <a href="/admin" class="nav-link">
              <span class="nav-link__number">04</span>
              <span class="nav-link__text">ADMIN</span>
            </a>
          )}
        </div>

        <div class="nav-auth">
          <!-- Theme Toggle -->
          <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
            <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">☀</span>
            <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">☾</span>
          </button>

          {user ? (
            <a href="/dashboard" class="btn-brutal">
              DASHBOARD
            </a>
          ) : (
            <a href="/login" class="btn-brutal btn-brutal--outline">
              ENTER →
            </a>
          )}
        </div>
      </nav>

      <!-- MARQUEE STRIP -->
      <div class="marquee-brutal">
        <div class="marquee-brutal__content">
          FREE LOGOS • OPEN SOURCE • COMMUNITY DRIVEN • FREE LOGOS • OPEN SOURCE • COMMUNITY DRIVEN • FREE LOGOS • OPEN SOURCE • COMMUNITY DRIVEN • FREE LOGOS • OPEN SOURCE • COMMUNITY DRIVEN •&nbsp;
        </div>
      </div>
    </header>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container"></div>

    <!-- MAIN CONTENT -->
    <main>
      <slot />
    </main>

    <!-- BRUTAL FOOTER -->
    <footer class="footer-brutal">
      <div class="footer-content">
        <div class="footer-brand">
          <h2 class="footer-logo">ASSET<br/>PIPE</h2>
          <p class="footer-tagline">OPEN SOURCE<br/>BRAND ASSETS</p>
        </div>

        <div class="footer-grid">
          <div class="footer-col">
            <h3 class="footer-heading">NAVIGATE</h3>
            <ul class="footer-list">
              <li><a href="/browse">Browse Logos</a></li>
              <li><a href="/submit">Submit Logo</a></li>
              <li><a href="/docs">API Documentation</a></li>
            </ul>
          </div>
          <div class="footer-col">
            <h3 class="footer-heading">CONNECT</h3>
            <ul class="footer-list">
              <li><a href="https://github.com/your-repo/assetpipe" target="_blank">GitHub ↗</a></li>
              <li><a href="/privacy">Privacy Policy</a></li>
              <li><a href="/terms">Terms of Use</a></li>
            </ul>
          </div>
          <div class="footer-col footer-col--highlight">
            <h3 class="footer-heading">BUILT BY</h3>
            <a href="https://twitter.com/itskritix" target="_blank" rel="noopener noreferrer" class="footer-author">@ITSKRITIX ↗</a>
            <p class="footer-tech">ASTRO + CLOUDFLARE + SUPABASE</p>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <p>© 2024 ASSETPIPE — ALL ASSETS FREE TO USE</p>
        <p class="footer-coords">51.5074° N, 0.1278° W</p>
      </div>
    </footer>
  </body>
</html>

<style is:global>
  /* HEADER STYLES */
  .header-brutal {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--brutal-cream);
    border-bottom: var(--border-thick) solid var(--brutal-black);
  }

  .nav-brutal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    max-width: 1800px;
    margin: 0 auto;
  }

  .logo-brutal {
    font-family: var(--font-display);
    font-size: 1.75rem;
    letter-spacing: 0.05em;
    display: flex;
    gap: 0;
    text-decoration: none;
  }

  .logo-text {
    color: var(--brutal-black);
  }

  .logo-accent {
    color: var(--brutal-white);
    background: var(--brutal-black);
    padding: 0 0.25rem;
    margin-left: 2px;
  }

  .logo-brutal:hover .logo-accent {
    background: var(--brutal-red);
  }

  .nav-links {
    display: flex;
    gap: var(--space-lg);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    text-decoration: none;
    transition: transform 0.1s ease;
  }

  .nav-link:hover {
    transform: translateY(-2px);
  }

  .nav-link__number {
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: #888;
    letter-spacing: 0.1em;
  }

  .nav-link__text {
    font-family: var(--font-display);
    font-size: 1.25rem;
    color: var(--brutal-black);
    letter-spacing: 0.05em;
  }

  .nav-link:hover .nav-link__text {
    color: var(--brutal-red);
  }

  .nav-link--hidden {
    display: none !important;
  }

  .nav-auth {
    display: flex;
    gap: var(--space-md);
  }

  /* FOOTER STYLES */
  .footer-brutal {
    background: var(--brutal-black);
    color: var(--brutal-white);
    margin-top: auto;
  }

  .footer-content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: var(--space-xl);
    max-width: 1800px;
    margin: 0 auto;
    padding: var(--space-xxl) var(--space-lg);
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }

  .footer-brand {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .footer-logo {
    font-family: var(--font-display);
    font-size: 4rem;
    line-height: 0.85;
    letter-spacing: 0.05em;
  }

  .footer-tagline {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    opacity: 0.6;
    line-height: 1.6;
  }

  .footer-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-xl);
  }

  .footer-col {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .footer-col--highlight {
    background: var(--brutal-yellow);
    color: var(--brutal-black);
    padding: var(--space-lg);
    margin: calc(var(--space-lg) * -1);
  }

  .footer-heading {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    opacity: 0.6;
    text-transform: uppercase;
  }

  .footer-col--highlight .footer-heading {
    opacity: 1;
  }

  .footer-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .footer-list a {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--brutal-white);
    text-decoration: none;
    transition: opacity 0.1s ease;
  }

  .footer-list a:hover {
    opacity: 0.6;
    color: var(--brutal-white);
  }

  .footer-author {
    display: inline-block;
    font-family: var(--font-display);
    font-size: 1.75rem;
    letter-spacing: 0.05em;
    color: var(--brutal-black);
    text-decoration: none;
    transition: all 0.1s ease;
    margin-bottom: var(--space-sm);
  }

  .footer-author:hover {
    color: var(--brutal-red);
  }

  .footer-tech {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    line-height: 1.2;
    opacity: 0.6;
  }

  .footer-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1800px;
    margin: 0 auto;
    padding: var(--space-lg);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    opacity: 0.6;
  }

  .footer-coords {
    font-variant-numeric: tabular-nums;
  }

  /* RESPONSIVE */
  @media (max-width: 1024px) {
    .nav-links {
      display: none;
    }

    .footer-content {
      grid-template-columns: 1fr;
    }

    .footer-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  @media (max-width: 640px) {
    .footer-grid {
      grid-template-columns: 1fr;
    }

    .footer-logo {
      font-size: 2.5rem;
    }
  }
</style>

<script is:inline>
  // Global Toast Notification System
  window.toast = function(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const icons = {
      success: '✓',
      error: '✕',
      warning: '!',
      info: '→'
    };

    const toast = document.createElement('div');
    toast.className = `toast toast--${type}`;
    toast.innerHTML = `
      <span class="toast__icon">${icons[type] || icons.info}</span>
      <span class="toast__message">${message}</span>
      <button class="toast__close" aria-label="Close">✕</button>
    `;

    container.appendChild(toast);

    // Trigger animation
    requestAnimationFrame(() => {
      toast.classList.add('toast--visible');
    });

    // Close button handler
    const closeBtn = toast.querySelector('.toast__close');
    closeBtn.addEventListener('click', () => dismissToast(toast));

    // Auto dismiss
    if (duration > 0) {
      setTimeout(() => dismissToast(toast), duration);
    }

    function dismissToast(toastEl) {
      toastEl.classList.remove('toast--visible');
      toastEl.classList.add('toast--exiting');
      setTimeout(() => {
        if (toastEl.parentNode) {
          toastEl.parentNode.removeChild(toastEl);
        }
      }, 200);
    }

    return toast;
  };

  // Convenience methods
  window.toast.success = (msg, duration) => window.toast(msg, 'success', duration);
  window.toast.error = (msg, duration) => window.toast(msg, 'error', duration);
  window.toast.warning = (msg, duration) => window.toast(msg, 'warning', duration);
  window.toast.info = (msg, duration) => window.toast(msg, 'info', duration);
</script>

<script is:inline>
  // Theme Management System
  (function() {
    const THEME_KEY = 'assetpipe-theme';

    // Get the preferred theme: localStorage > system preference > light
    function getPreferredTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      if (stored) return stored;

      // Check system preference
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }

      return 'light';
    }

    // Apply theme to document
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);

      // Update meta theme-color for mobile browsers
      const metaThemeColor = document.querySelector('meta[name="theme-color"]');
      if (metaThemeColor) {
        metaThemeColor.setAttribute('content', theme === 'dark' ? '#121212' : '#f5f0e8');
      }
    }

    // Toggle between light and dark
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const next = current === 'dark' ? 'light' : 'dark';

      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    }

    // Initialize theme immediately to prevent flash
    applyTheme(getPreferredTheme());

    // Set up toggle button when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const toggle = document.getElementById('theme-toggle');
      if (toggle) {
        toggle.addEventListener('click', toggleTheme);
      }
    });

    // Listen for system preference changes
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        // Only auto-switch if user hasn't manually set a preference
        if (!localStorage.getItem(THEME_KEY)) {
          applyTheme(e.matches ? 'dark' : 'light');
        }
      });
    }

    // Expose for external use
    window.theme = {
      toggle: toggleTheme,
      set: function(theme) {
        localStorage.setItem(THEME_KEY, theme);
        applyTheme(theme);
      },
      get: function() {
        return document.documentElement.getAttribute('data-theme') || 'light';
      }
    };
  })();
</script>
