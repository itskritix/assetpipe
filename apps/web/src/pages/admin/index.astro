---
import Layout from '../../layouts/Layout.astro';
import { createSupabaseServer } from '../../lib/supabase';

const supabase = createSupabaseServer(Astro.cookies, Astro.request.headers.get('cookie'));
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Check if user is admin (you would need an admin check in production)
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single();

if (profile?.role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const { data: pendingSubmissions } = await supabase
  .from('submissions')
  .select('id, company_name, created_at, user_id')
  .eq('status', 'pending')
  .order('created_at', { ascending: true })
  .limit(10);

const { data: stats } = await supabase
  .from('submissions')
  .select('status');

const { count: companiesCount } = await supabase
  .from('companies')
  .select('*', { count: 'exact', head: true });

const { count: logosCount } = await supabase
  .from('logos')
  .select('*', { count: 'exact', head: true });

const pendingCount = stats?.filter(s => s.status === 'pending').length || 0;
const totalSubmissions = stats?.length || 0;
---

<Layout title="Admin Dashboard">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <span class="tag-brutal tag-brutal--red">ADMIN</span>
        <h2>CONTROL PANEL</h2>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin" class="nav-item nav-item--active">
          <span class="nav-icon">?</span> OVERVIEW
        </a>
        <a href="/admin/submissions" class="nav-item">
          <span class="nav-icon">?</span> REVIEW QUEUE
          {pendingCount > 0 && <span class="nav-badge">{pendingCount}</span>}
        </a>
        <a href="/admin/companies" class="nav-item">
          <span class="nav-icon">?</span> COMPANIES
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="nav-icon">?</span> USERS
        </a>
      </nav>

      <div class="sidebar-footer">
        <a href="/dashboard" class="btn-brutal btn-brutal--outline">BACK TO DASHBOARD</a>
      </div>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <h1>ADMIN OVERVIEW</h1>
        <span class="admin-user">{user.email}</span>
      </header>

      <section class="admin-stats">
        <div class="admin-stat-card admin-stat-card--alert">
          <span class="admin-stat__number">{pendingCount}</span>
          <span class="admin-stat__label">PENDING REVIEW</span>
        </div>
        <div class="admin-stat-card">
          <span class="admin-stat__number">{totalSubmissions}</span>
          <span class="admin-stat__label">TOTAL SUBMISSIONS</span>
        </div>
        <div class="admin-stat-card">
          <span class="admin-stat__number">{companiesCount || 0}</span>
          <span class="admin-stat__label">COMPANIES</span>
        </div>
        <div class="admin-stat-card">
          <span class="admin-stat__number">{logosCount || 0}</span>
          <span class="admin-stat__label">LOGOS</span>
        </div>
      </section>

      <section class="admin-section">
        <div class="section-header-dash">
          <h2>PENDING SUBMISSIONS</h2>
          <a href="/admin/submissions" class="link-brutal">VIEW ALL</a>
        </div>

        {pendingSubmissions && pendingSubmissions.length > 0 ? (
          <div class="admin-table">
            {pendingSubmissions.map(sub => (
              <a href={'/admin/submissions/' + sub.id} class="admin-row">
                <span class="admin-row__company">{sub.company_name}</span>
                <span class="admin-row__date">{new Date(sub.created_at).toLocaleDateString()}</span>
                <span class="admin-row__action">REVIEW</span>
              </a>
            ))}
          </div>
        ) : (
          <div class="empty-dash">
            <p>NO PENDING SUBMISSIONS</p>
          </div>
        )}
      </section>
    </main>
  </div>
</Layout>
