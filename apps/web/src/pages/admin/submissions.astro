---
import Layout from '../../layouts/Layout.astro';
import { isAdmin } from '../../lib/config';

const supabase = Astro.locals.supabase;
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

// Check if user is admin using email list
if (!isAdmin(user.email)) {
  return Astro.redirect('/dashboard');
}

const status = Astro.url.searchParams.get('status') || 'pending';

const { data: submissions } = await supabase!
  .from('submissions')
  .select('id, company_name, company_domain, status, created_at, user_id, submission_files(id, format, variant_type, color_mode, storage_path)')
  .eq('status', status)
  .order('created_at', { ascending: true });

// Generate signed URLs for all submission files
interface SubmissionWithUrls {
  id: string;
  company_name: string;
  company_domain: string | null;
  status: string;
  created_at: string;
  user_id: string;
  submission_files: Array<{
    id: string;
    format: string;
    variant_type: string;
    color_mode: string;
    storage_path: string;
    signedUrl?: string;
  }>;
}

const submissionsWithUrls: SubmissionWithUrls[] = [];
if (submissions) {
  for (const sub of submissions) {
    const filesWithUrls = [];
    for (const file of sub.submission_files || []) {
      const { data: signedData } = await supabase!.storage
        .from('submissions')
        .createSignedUrl(file.storage_path, 3600);
      filesWithUrls.push({
        ...file,
        signedUrl: signedData?.signedUrl || '',
      });
    }
    submissionsWithUrls.push({
      ...sub,
      submission_files: filesWithUrls,
    });
  }
}

const { data: stats } = await supabase!
  .from('submissions')
  .select('status');

const pendingCount = stats?.filter((s: { status: string }) => s.status === 'pending').length || 0;
const approvedCount = stats?.filter((s: { status: string }) => s.status === 'approved').length || 0;
const rejectedCount = stats?.filter((s: { status: string }) => s.status === 'rejected').length || 0;
---

<Layout title="Review Submissions">
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <span class="tag-brutal tag-brutal--red">ADMIN</span>
        <h2>CONTROL PANEL</h2>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin" class="nav-item">
          <span class="nav-icon">?</span> OVERVIEW
        </a>
        <a href="/admin/submissions" class="nav-item nav-item--active">
          <span class="nav-icon">?</span> REVIEW QUEUE
          {pendingCount > 0 && <span class="nav-badge">{pendingCount}</span>}
        </a>
        <a href="/admin/companies" class="nav-item">
          <span class="nav-icon">?</span> COMPANIES
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="nav-icon">?</span> USERS
        </a>
      </nav>

      <div class="sidebar-footer">
        <a href="/dashboard" class="btn-brutal btn-brutal--outline">BACK TO DASHBOARD</a>
      </div>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <h1>REVIEW QUEUE</h1>
      </header>

      <div class="filter-tabs">
        <a href="/admin/submissions?status=pending" class={"filter-tab " + (status === 'pending' ? 'filter-tab--active' : '')}>
          PENDING ({pendingCount})
        </a>
        <a href="/admin/submissions?status=approved" class={"filter-tab " + (status === 'approved' ? 'filter-tab--active' : '')}>
          APPROVED ({approvedCount})
        </a>
        <a href="/admin/submissions?status=rejected" class={"filter-tab " + (status === 'rejected' ? 'filter-tab--active' : '')}>
          REJECTED ({rejectedCount})
        </a>
      </div>

      <section class="review-list">
        {submissionsWithUrls.length > 0 ? (
          submissionsWithUrls.map((sub) => (
            <div class="review-card" data-id={sub.id}>
              <div class="review-card__header">
                <div>
                  <h3>{sub.company_name}</h3>
                  {sub.company_domain && <span class="review-domain">{sub.company_domain}</span>}
                </div>
                <span class="review-date">{new Date(sub.created_at).toLocaleDateString()}</span>
              </div>

              <div class="review-card__files">
                {sub.submission_files?.map((file) => (
                  <div class="review-file">
                    <img src={file.signedUrl || ''} alt={`${file.variant_type} ${file.color_mode}`} class="review-preview" />
                    <div class="file-meta">
                      <span class="file-format">{file.format.toUpperCase()}</span>
                      <span class="file-variant">{file.variant_type.toUpperCase()}</span>
                      <span class="file-color">{file.color_mode.toUpperCase()}</span>
                    </div>
                  </div>
                ))}
              </div>

              {status === 'pending' && (
                <div class="review-card__actions">
                  <button class="btn-brutal btn-brutal--green approve-btn" data-id={sub.id}>APPROVE</button>
                  <button class="btn-brutal btn-brutal--outline reject-btn" data-id={sub.id}>REJECT</button>
                </div>
              )}
            </div>
          ))
        ) : (
          <div class="empty-dash">
            <p>NO {status.toUpperCase()} SUBMISSIONS</p>
          </div>
        )}
      </section>
    </main>
  </div>
</Layout>

<script>
  import { createBrowserClient } from '@supabase/ssr';
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

  document.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = (btn as HTMLElement).dataset.id;
      const button = btn as HTMLButtonElement;

      button.disabled = true;
      button.textContent = 'PROCESSING...';

      try {
        const response = await fetch('/api/admin/approve-submission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ submissionId: id }),
          credentials: 'include',
        });

        const result = await response.json();

        if (response.ok) {
          window.toast?.success('Submission approved! Company and logos created.');
          setTimeout(() => location.reload(), 1000);
        } else {
          window.toast?.error(result.error || 'Failed to approve');
          button.disabled = false;
          button.textContent = 'APPROVE';
        }
      } catch (error) {
        console.error('Approval error:', error);
        window.toast?.error('Failed to approve submission');
        button.disabled = false;
        button.textContent = 'APPROVE';
      }
    });
  });

  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = (btn as HTMLElement).dataset.id;
      const { error } = await supabase.from('submissions').update({ status: 'rejected' }).eq('id', id);
      if (!error) {
        window.toast?.success('Submission rejected');
        setTimeout(() => location.reload(), 500);
      } else {
        window.toast?.error('Failed to reject');
      }
    });
  });
</script>
