---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

interface Logo {
  id: string;
  format: string;
  variant_type: string;
  color_mode: string;
  storage_path: string;
}

interface Company {
  id: string;
  name: string;
  slug: string;
  domain: string | null;
  logos: Logo[];
}

const searchQuery = Astro.url.searchParams.get('q') || '';
const format = Astro.url.searchParams.get('format') || '';

const { data } = await supabase
  .from('companies')
  .select(`
    id,
    name,
    slug,
    domain,
    logos (
      id,
      format,
      variant_type,
      color_mode,
      storage_path
    )
  `)
  .ilike('name', searchQuery ? `%${searchQuery}%` : '%')
  .order('name')
  .limit(50);

const companies = data as Company[] | null;
const totalCount = companies?.length || 0;
---

<Layout title="Browse Logos">
  <!-- BROWSE HEADER -->
  <section class="browse-header">
    <div class="browse-header__content">
      <div class="browse-header__title">
        <span class="tag-brutal">LOGO LIBRARY</span>
        <h1>BROWSE</h1>
      </div>
      <div class="browse-header__count">
        <span class="count-number">{totalCount}</span>
        <span class="count-label">COMPANIES<br/>FOUND</span>
      </div>
    </div>
  </section>

  <!-- SEARCH & FILTERS -->
  <section class="browse-search">
    <form method="get" class="search-form-brutal">
      <div class="search-row">
        <input
          type="text"
          name="q"
          value={searchQuery}
          placeholder="SEARCH COMPANIES..."
          class="input-brutal search-input-large"
          autocomplete="off"
        />
        <button type="submit" class="btn-brutal btn-brutal--yellow search-submit">
          SEARCH →
        </button>
      </div>

      <div class="filter-row">
        <span class="filter-label">FILTER BY FORMAT:</span>
        <div class="filter-options">
          <a
            href={`/browse${searchQuery ? `?q=${searchQuery}` : ''}`}
            class={`filter-tag ${!format ? 'filter-tag--active' : ''}`}
          >
            ALL
          </a>
          <a
            href={`/browse?${searchQuery ? `q=${searchQuery}&` : ''}format=svg`}
            class={`filter-tag ${format === 'svg' ? 'filter-tag--active' : ''}`}
          >
            SVG
          </a>
          <a
            href={`/browse?${searchQuery ? `q=${searchQuery}&` : ''}format=png`}
            class={`filter-tag ${format === 'png' ? 'filter-tag--active' : ''}`}
          >
            PNG
          </a>
        </div>
      </div>
    </form>
  </section>

  <!-- LOGO GRID -->
  <section class="browse-grid-section">
    {companies && companies.length > 0 ? (
      <div class="logo-grid-brutal">
        {companies.map((company, index) => (
          <a
            href={`/company/${company.slug}`}
            class={`logo-card-brutal ${index % 5 === 0 ? 'logo-card-brutal--featured' : ''}`}
          >
            <div class="logo-card__preview">
              {company.logos && company.logos[0] ? (
                <img
                  src={company.logos[0].storage_path}
                  alt={company.name}
                  loading="lazy"
                />
              ) : (
                <span class="logo-card__placeholder">
                  {company.name.charAt(0)}
                </span>
              )}
            </div>
            <div class="logo-card__info">
              <h3 class="logo-card__name">{company.name}</h3>
              {company.domain && (
                <span class="logo-card__domain">{company.domain}</span>
              )}
              <div class="logo-card__meta">
                <span class="tag-brutal tag-brutal--outline">
                  {company.logos?.length || 0} LOGO{(company.logos?.length || 0) !== 1 ? 'S' : ''}
                </span>
              </div>
            </div>
            <div class="logo-card__arrow">→</div>
          </a>
        ))}
      </div>
    ) : (
      <div class="empty-state-brutal">
        <div class="empty-state__content">
          <h2>NO RESULTS</h2>
          {searchQuery && (
            <p>No logos found for "{searchQuery}"</p>
          )}
          <div class="empty-state__actions">
            <a href="/browse" class="btn-brutal btn-brutal--outline">
              CLEAR SEARCH
            </a>
            <a href="/submit" class="btn-brutal btn-brutal--yellow">
              SUBMIT A LOGO →
            </a>
          </div>
        </div>
      </div>
    )}
  </section>

  <!-- PAGINATION PLACEHOLDER -->
  {companies && companies.length >= 50 && (
    <section class="browse-pagination">
      <div class="pagination-content">
        <span class="pagination-text">SHOWING FIRST 50 RESULTS</span>
        <span class="pagination-text">MORE COMING SOON</span>
      </div>
    </section>
  )}
</Layout>
