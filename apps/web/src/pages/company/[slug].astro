---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

interface Logo {
  id: string;
  format: string;
  variant: string;
  storage_path: string;
  width: number | null;
  height: number | null;
  file_size: number | null;
}

interface BrandKit {
  id: string;
  primary_color: string | null;
  secondary_colors: string[] | null;
  fonts: Record<string, string> | null;
  guidelines_url: string | null;
}

interface Company {
  id: string;
  name: string;
  slug: string;
  domain: string | null;
  description: string | null;
  website_url: string | null;
  is_verified: boolean;
  logos: Logo[];
  brand_kits: BrandKit[];
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

const { data } = await supabase
  .from('companies')
  .select(`
    id,
    name,
    slug,
    domain,
    description,
    website_url,
    is_verified,
    logos (
      id,
      format,
      variant,
      storage_path,
      width,
      height,
      file_size
    ),
    brand_kits (
      id,
      primary_color,
      secondary_colors,
      fonts,
      guidelines_url
    )
  `)
  .eq('slug', slug)
  .single();

const company = data as Company | null;

if (!company) {
  return Astro.redirect('/404');
}

const formatBytes = (bytes: number | null) => {
  if (!bytes) return 'N/A';
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
};

const brandKit = company.brand_kits?.[0];
---

<Layout title={company.name} description={`Download ${company.name} logos in SVG and PNG formats`}>
  <!-- COMPANY HEADER -->
  <section class="company-header">
    <div class="company-header__content">
      <div class="company-header__breadcrumb">
        <a href="/browse" class="breadcrumb-link">← BROWSE</a>
      </div>

      <div class="company-header__main">
        <div class="company-header__info">
          <div class="company-name-row">
            <h1>{company.name.toUpperCase()}</h1>
            {company.is_verified && (
              <span class="tag-brutal tag-brutal--green">VERIFIED</span>
            )}
          </div>
          {company.domain && (
            <span class="company-domain">{company.domain}</span>
          )}
        </div>

        <div class="company-header__meta">
          <div class="meta-stat">
            <span class="meta-number">{company.logos?.length || 0}</span>
            <span class="meta-label">LOGOS</span>
          </div>
          {company.website_url && (
            <a href={company.website_url} target="_blank" rel="noopener noreferrer" class="btn-brutal btn-brutal--outline">
              VISIT SITE ↗
            </a>
          )}
        </div>
      </div>

      {company.description && (
        <p class="company-description">{company.description}</p>
      )}
    </div>
  </section>

  <!-- LOGOS SECTION -->
  <section class="logos-section">
    <div class="section-header-brutal">
      <span class="tag-brutal">ASSETS</span>
      <h2>AVAILABLE LOGOS</h2>
    </div>

    {company.logos && company.logos.length > 0 ? (
      <div class="logos-grid-brutal">
        {company.logos.map((logo, index) => (
          <div class={`logo-item-brutal ${index === 0 ? 'logo-item-brutal--primary' : ''}`}>
            <div class="logo-item__preview">
              <img
                src={logo.storage_path}
                alt={`${company.name} ${logo.variant}`}
                loading="lazy"
              />
            </div>

            <div class="logo-item__details">
              <div class="logo-item__info">
                <h3 class="logo-item__variant">{logo.variant.toUpperCase()}</h3>
                <div class="logo-item__specs">
                  <span class="spec-tag">{logo.format.toUpperCase()}</span>
                  {logo.width && logo.height && (
                    <span class="spec-dim">{logo.width} × {logo.height}</span>
                  )}
                  <span class="spec-size">{formatBytes(logo.file_size)}</span>
                </div>
              </div>

              <a
                href={logo.storage_path}
                download={`${company.slug}-${logo.variant}.${logo.format}`}
                class="btn-brutal btn-brutal--yellow logo-download"
              >
                DOWNLOAD →
              </a>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div class="empty-logos-brutal">
        <p>NO LOGOS AVAILABLE YET</p>
        <a href="/submit" class="btn-brutal">SUBMIT ONE →</a>
      </div>
    )}
  </section>

  <!-- BRAND KIT SECTION -->
  {brandKit && (
    <section class="brandkit-section">
      <div class="section-header-brutal">
        <span class="tag-brutal tag-brutal--yellow">IDENTITY</span>
        <h2>BRAND KIT</h2>
      </div>

      <div class="brandkit-grid">
        {brandKit.primary_color && (
          <div class="brandkit-card brandkit-card--color">
            <h3>PRIMARY COLOR</h3>
            <div class="color-display">
              <div class="color-swatch" style={`background-color: ${brandKit.primary_color}`}></div>
              <div class="color-info">
                <code class="color-hex">{brandKit.primary_color}</code>
                <span class="color-label">HEX</span>
              </div>
            </div>
          </div>
        )}

        {brandKit.secondary_colors && brandKit.secondary_colors.length > 0 && (
          <div class="brandkit-card brandkit-card--palette">
            <h3>SECONDARY COLORS</h3>
            <div class="palette-display">
              {brandKit.secondary_colors.map((color) => (
                <div class="palette-item">
                  <div class="palette-swatch" style={`background-color: ${color}`}></div>
                  <code class="palette-hex">{color}</code>
                </div>
              ))}
            </div>
          </div>
        )}

        {brandKit.fonts && Object.keys(brandKit.fonts).length > 0 && (
          <div class="brandkit-card brandkit-card--fonts">
            <h3>TYPOGRAPHY</h3>
            <div class="fonts-display">
              {Object.entries(brandKit.fonts).map(([usage, font]) => (
                <div class="font-item">
                  <span class="font-usage">{usage.toUpperCase()}</span>
                  <span class="font-name">{font}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {brandKit.guidelines_url && (
          <div class="brandkit-card brandkit-card--guidelines">
            <h3>GUIDELINES</h3>
            <a href={brandKit.guidelines_url} target="_blank" rel="noopener noreferrer" class="btn-brutal">
              VIEW BRAND GUIDELINES ↗
            </a>
          </div>
        )}
      </div>
    </section>
  )}

  <!-- API SECTION -->
  <section class="api-section-brutal">
    <div class="api-section__content">
      <div class="api-section__info">
        <span class="tag-brutal tag-brutal--green">DEVELOPERS</span>
        <h2>API ACCESS</h2>
        <p>Fetch this company's logos programmatically via our REST API.</p>
        <a href="/docs" class="btn-brutal btn-brutal--outline">
          FULL API DOCS →
        </a>
      </div>

      <div class="api-section__code">
        <div class="code-header-brutal">
          <span class="code-lang">BASH</span>
          <span class="code-filename">request.sh</span>
        </div>
        <pre class="code-block-brutal"><code><span class="code-comment"># Get all logos for {company.name}</span>
curl -X GET \
  "https://api.assetpipe.com/v1/companies/{company.slug}/logos" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json"</code></pre>
      </div>
    </div>
  </section>

  <!-- RELATED CTA -->
  <section class="related-cta">
    <div class="related-cta__content">
      <h3>MISSING A LOGO?</h3>
      <p>Help us grow by submitting additional variants for {company.name}.</p>
      <a href="/submit" class="btn-brutal btn-brutal--yellow">
        SUBMIT A LOGO →
      </a>
    </div>
  </section>
</Layout>
