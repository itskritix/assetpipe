---
import Layout from '../../layouts/Layout.astro';
import { createSupabaseServer } from '../../lib/supabase';

const supabase = createSupabaseServer(Astro.cookies, Astro.request.headers.get('cookie'));
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

const { data: apiKeys } = await supabase
  .from('api_keys')
  .select('id, name, key_prefix, created_at, last_used_at, is_active')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });
---

<Layout title="API Keys">
  <div class="dashboard-layout">
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <span class="tag-brutal tag-brutal--yellow">DASHBOARD</span>
        <h2>MY ACCOUNT</h2>
      </div>

      <nav class="sidebar-nav">
        <a href="/dashboard" class="nav-item">
          <span class="nav-icon">O</span> OVERVIEW
        </a>
        <a href="/dashboard/submissions" class="nav-item">
          <span class="nav-icon">+</span> MY SUBMISSIONS
        </a>
        <a href="/dashboard/api-keys" class="nav-item nav-item--active">
          <span class="nav-icon">#</span> API KEYS
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logout-btn" class="btn-brutal btn-brutal--outline logout-btn">LOGOUT</button>
      </div>
    </aside>

    <main class="dashboard-main">
      <header class="dashboard-header">
        <div class="dashboard-header__title">
          <h1>API KEYS</h1>
          <p class="user-email">Manage your API access</p>
        </div>
        <button id="create-key-btn" class="btn-brutal btn-brutal--yellow">+ NEW API KEY</button>
      </header>

      <section class="dashboard-section">
        <div class="api-info-box">
          <div class="api-info-icon">{`</>`}</div>
          <div class="api-info-content">
            <h3>API DOCUMENTATION</h3>
            <p>Use your API keys to access the AssetPipe API programmatically. Keys are shown only once when created - store them securely.</p>
          </div>
          <a href="/docs" class="btn-brutal">VIEW DOCS</a>
        </div>
      </section>

      <section class="dashboard-section">
        <h2>YOUR API KEYS</h2>

        {apiKeys && apiKeys.length > 0 ? (
          <div class="api-keys-list">
            {apiKeys.map(key => (
              <div class="api-key-card">
                <div class="api-key-info">
                  <span class="api-key-name">{key.name}</span>
                  <span class="api-key-prefix">{key.key_prefix}...****</span>
                </div>
                <div class="api-key-meta">
                  <span class="api-key-date">Created: {new Date(key.created_at).toLocaleDateString()}</span>
                  {key.last_used_at && (
                    <span class="api-key-used">Last used: {new Date(key.last_used_at).toLocaleDateString()}</span>
                  )}
                </div>
                <div class="api-key-actions">
                  <span class={`status-tag status-tag--${key.is_active ? 'approved' : 'rejected'}`}>
                    {key.is_active ? 'ACTIVE' : 'REVOKED'}
                  </span>
                  {key.is_active && (
                    <button class="btn-brutal btn-brutal--small btn-brutal--red revoke-btn" data-key-id={key.id}>
                      REVOKE
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-dash">
            <p>NO API KEYS YET</p>
            <p class="empty-subtitle">Create an API key to start using the AssetPipe API</p>
          </div>
        )}
      </section>

      <section class="dashboard-section">
        <h2>USAGE LIMITS</h2>
        <div class="usage-grid">
          <div class="usage-card">
            <span class="usage-label">REQUESTS TODAY</span>
            <span class="usage-value">0 / 1,000</span>
            <div class="usage-bar">
              <div class="usage-bar-fill" style="width: 0%"></div>
            </div>
          </div>
          <div class="usage-card">
            <span class="usage-label">REQUESTS THIS MONTH</span>
            <span class="usage-value">0 / 10,000</span>
            <div class="usage-bar">
              <div class="usage-bar-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Create Key Modal -->
  <div id="create-key-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>CREATE NEW API KEY</h2>
        <button class="modal-close">&times;</button>
      </div>
      <form id="create-key-form" class="modal-body">
        <div class="form-field">
          <label for="key-name" class="label-brutal">KEY NAME</label>
          <input type="text" id="key-name" name="name" required placeholder="e.g. Production API" class="input-brutal" />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-brutal btn-brutal--outline modal-cancel">CANCEL</button>
          <button type="submit" class="btn-brutal btn-brutal--yellow">CREATE KEY</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Show Key Modal -->
  <div id="show-key-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>API KEY CREATED</h2>
      </div>
      <div class="modal-body">
        <div class="warning-box">
          <strong>IMPORTANT:</strong> Copy your API key now. You won't be able to see it again!
        </div>
        <div class="api-key-display">
          <code id="new-key-value"></code>
          <button id="copy-key-btn" class="btn-brutal btn-brutal--small">COPY</button>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-brutal btn-brutal--yellow modal-done">DONE</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { createBrowserClient } from '@supabase/ssr';
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  });

  // Modal handling
  const createKeyModal = document.getElementById('create-key-modal');
  const showKeyModal = document.getElementById('show-key-modal');
  const createKeyBtn = document.getElementById('create-key-btn');
  const createKeyForm = document.getElementById('create-key-form');

  createKeyBtn?.addEventListener('click', () => {
    createKeyModal?.classList.remove('hidden');
  });

  createKeyModal?.querySelector('.modal-backdrop')?.addEventListener('click', () => {
    createKeyModal?.classList.add('hidden');
  });

  createKeyModal?.querySelector('.modal-close')?.addEventListener('click', () => {
    createKeyModal?.classList.add('hidden');
  });

  createKeyModal?.querySelector('.modal-cancel')?.addEventListener('click', () => {
    createKeyModal?.classList.add('hidden');
  });

  showKeyModal?.querySelector('.modal-done')?.addEventListener('click', () => {
    showKeyModal?.classList.add('hidden');
    window.location.reload();
  });

  // Create key form
  createKeyForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = (document.getElementById('key-name') as HTMLInputElement).value;

    // Generate a random API key
    const key = 'ap_' + crypto.randomUUID().replace(/-/g, '');
    const keyPrefix = key.substring(0, 10);

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { error } = await supabase.from('api_keys').insert({
      user_id: user.id,
      name,
      key_hash: key, // In production, hash this!
      key_prefix: keyPrefix,
      is_active: true
    });

    if (error) {
      alert('Failed to create API key: ' + error.message);
      return;
    }

    createKeyModal?.classList.add('hidden');
    const newKeyValue = document.getElementById('new-key-value');
    if (newKeyValue) newKeyValue.textContent = key;
    showKeyModal?.classList.remove('hidden');
  });

  // Copy key
  document.getElementById('copy-key-btn')?.addEventListener('click', () => {
    const key = document.getElementById('new-key-value')?.textContent;
    if (key) {
      navigator.clipboard.writeText(key);
      const btn = document.getElementById('copy-key-btn');
      if (btn) btn.textContent = 'COPIED!';
    }
  });

  // Revoke keys
  document.querySelectorAll('.revoke-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const keyId = (btn as HTMLElement).dataset.keyId;
      if (!confirm('Are you sure you want to revoke this API key?')) return;

      const { error } = await supabase
        .from('api_keys')
        .update({ is_active: false })
        .eq('id', keyId);

      if (error) {
        alert('Failed to revoke key: ' + error.message);
        return;
      }

      window.location.reload();
    });
  });
</script>
