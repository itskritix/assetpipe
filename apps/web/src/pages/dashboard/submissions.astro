---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="My Submissions">
  <div class="mx-auto max-w-4xl px-4 py-12">
    <div class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">My Submissions</h1>
        <p class="mt-2 text-gray-600">Track the status of your logo submissions.</p>
      </div>
      <a
        href="/submit"
        class="rounded-lg bg-brand-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-brand-700"
      >
        Submit New Logo
      </a>
    </div>

    <div id="loading" class="text-center py-12">
      <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-brand-600 border-r-transparent"></div>
      <p class="mt-2 text-gray-600">Loading submissions...</p>
    </div>

    <div id="empty-state" class="hidden text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
      </svg>
      <h3 class="mt-4 text-lg font-medium text-gray-900">No submissions yet</h3>
      <p class="mt-2 text-gray-600">Get started by submitting your first logo.</p>
      <a
        href="/submit"
        class="mt-4 inline-block rounded-lg bg-brand-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-brand-700"
      >
        Submit a Logo
      </a>
    </div>

    <div id="submissions-list" class="hidden space-y-4"></div>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const loading = document.getElementById('loading');
  const emptyState = document.getElementById('empty-state');
  const submissionsList = document.getElementById('submissions-list');

  async function init() {
    // Check if user is logged in
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = '/login';
      return;
    }

    // Fetch submissions
    const { data: submissions, error } = await supabase
      .from('submissions')
      .select('*')
      .order('created_at', { ascending: false });

    loading?.classList.add('hidden');

    if (error) {
      console.error('Error fetching submissions:', error);
      return;
    }

    if (!submissions || submissions.length === 0) {
      emptyState?.classList.remove('hidden');
    } else {
      submissionsList?.classList.remove('hidden');

      const statusColors: Record<string, string> = {
        pending: 'bg-yellow-100 text-yellow-700',
        approved: 'bg-green-100 text-green-700',
        rejected: 'bg-red-100 text-red-700',
      };

      submissionsList!.innerHTML = submissions.map((sub) => `
        <div class="rounded-xl border bg-white p-6">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">${sub.company_name}</h3>
              ${sub.company_domain ? `<p class="text-sm text-gray-500">${sub.company_domain}</p>` : ''}
            </div>
            <span class="rounded-full px-3 py-1 text-xs font-medium ${statusColors[sub.status] || 'bg-gray-100 text-gray-700'}">
              ${sub.status.charAt(0).toUpperCase() + sub.status.slice(1)}
            </span>
          </div>
          <div class="mt-4 flex items-center gap-4 text-sm text-gray-500">
            <span>Submitted ${new Date(sub.created_at).toLocaleDateString()}</span>
            ${sub.reviewed_at ? `<span>Reviewed ${new Date(sub.reviewed_at).toLocaleDateString()}</span>` : ''}
          </div>
          ${sub.admin_notes ? `
            <div class="mt-4 rounded-lg bg-gray-50 p-3">
              <p class="text-sm text-gray-600"><strong>Admin notes:</strong> ${sub.admin_notes}</p>
            </div>
          ` : ''}
        </div>
      `).join('');
    }
  }

  init();
</script>
