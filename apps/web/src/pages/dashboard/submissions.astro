---
import Layout from '../../layouts/Layout.astro';
import { createSupabaseServer } from '../../lib/supabase';

const supabase = createSupabaseServer(Astro.cookies, Astro.request.headers.get('cookie'));
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

const { data: submissions } = await supabase
  .from('submissions')
  .select('id, company_name, company_domain, status, created_at, submission_files(id, format, variant_type, color_mode)')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });
---

<Layout title="My Submissions">
  <div class="dashboard-layout">
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <span class="tag-brutal tag-brutal--yellow">DASHBOARD</span>
        <h2>MY ACCOUNT</h2>
      </div>

      <nav class="sidebar-nav">
        <a href="/dashboard" class="nav-item">
          <span class="nav-icon">?</span> OVERVIEW
        </a>
        <a href="/dashboard/submissions" class="nav-item nav-item--active">
          <span class="nav-icon">?</span> MY SUBMISSIONS
        </a>
        <a href="/dashboard/api-keys" class="nav-item">
          <span class="nav-icon">?</span> API KEYS
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logout-btn" class="btn-brutal btn-brutal--outline logout-btn">LOGOUT</button>
      </div>
    </aside>

    <main class="dashboard-main">
      <header class="dashboard-header">
        <div class="dashboard-header__title">
          <h1>MY SUBMISSIONS</h1>
          <p>{submissions?.length || 0} TOTAL</p>
        </div>
        <a href="/submit" class="btn-brutal btn-brutal--yellow">NEW SUBMISSION</a>
      </header>

      <section class="submissions-list">
        {submissions && submissions.length > 0 ? (
          submissions.map(sub => (
            <div class="submission-card">
              <div class="submission-card__header">
                <div class="submission-card__info">
                  <h3>{sub.company_name}</h3>
                  {sub.company_domain && <span class="submission-domain">{sub.company_domain}</span>}
                </div>
                <span class={"status-tag status-tag--" + sub.status}>{sub.status.toUpperCase()}</span>
              </div>
              <div class="submission-card__meta">
                <span class="meta-item">
                  <span class="meta-label">FILES:</span>
                  {sub.submission_files?.length || 0}
                </span>
                <span class="meta-item">
                  <span class="meta-label">SUBMITTED:</span>
                  {new Date(sub.created_at).toLocaleDateString()}
                </span>
              </div>
              {sub.submission_files && sub.submission_files.length > 0 && (
                <div class="submission-card__files">
                  {sub.submission_files.map(file => (
                    <span class="file-tag">{file.format.toUpperCase()} / {file.variant_type.toUpperCase()} / {file.color_mode.toUpperCase()}</span>
                  ))}
                </div>
              )}
            </div>
          ))
        ) : (
          <div class="empty-dash">
            <h3>NO SUBMISSIONS YET</h3>
            <p>START CONTRIBUTING BY SUBMITTING YOUR FIRST LOGO</p>
            <a href="/submit" class="btn-brutal btn-brutal--yellow">SUBMIT A LOGO</a>
          </div>
        )}
      </section>
    </main>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  });
</script>
