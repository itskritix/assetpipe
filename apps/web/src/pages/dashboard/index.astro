---
import Layout from '../../layouts/Layout.astro';
import { createSupabaseServer } from '../../lib/supabase';

const supabase = createSupabaseServer(Astro.cookies, Astro.request.headers.get('cookie'));
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

const { data: submissions } = await supabase
  .from('submissions')
  .select('id, company_name, status, created_at')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false })
  .limit(5);

const { data: stats } = await supabase
  .from('submissions')
  .select('status')
  .eq('user_id', user.id);

const totalSubmissions = stats?.length || 0;
const approvedCount = stats?.filter(s => s.status === 'approved').length || 0;
const pendingCount = stats?.filter(s => s.status === 'pending').length || 0;
---

<Layout title="Dashboard">
  <div class="dashboard-layout">
    <aside class="dashboard-sidebar">
      <div class="sidebar-header">
        <span class="tag-brutal tag-brutal--yellow">DASHBOARD</span>
        <h2>MY ACCOUNT</h2>
      </div>

      <nav class="sidebar-nav">
        <a href="/dashboard" class="nav-item nav-item--active">
          <span class="nav-icon">?</span> OVERVIEW
        </a>
        <a href="/dashboard/submissions" class="nav-item">
          <span class="nav-icon">?</span> MY SUBMISSIONS
        </a>
        <a href="/dashboard/api-keys" class="nav-item">
          <span class="nav-icon">?</span> API KEYS
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logout-btn" class="btn-brutal btn-brutal--outline logout-btn">LOGOUT</button>
      </div>
    </aside>

    <main class="dashboard-main">
      <header class="dashboard-header">
        <div class="dashboard-header__title">
          <h1>OVERVIEW</h1>
          <p class="user-email">{user.email}</p>
        </div>
        <a href="/submit" class="btn-brutal btn-brutal--yellow">SUBMIT LOGO</a>
      </header>

      <section class="stats-grid">
        <div class="stat-card">
          <span class="stat-card__number">{totalSubmissions}</span>
          <span class="stat-card__label">TOTAL SUBMISSIONS</span>
        </div>
        <div class="stat-card stat-card--green">
          <span class="stat-card__number">{approvedCount}</span>
          <span class="stat-card__label">APPROVED</span>
        </div>
        <div class="stat-card stat-card--yellow">
          <span class="stat-card__number">{pendingCount}</span>
          <span class="stat-card__label">PENDING REVIEW</span>
        </div>
      </section>

      <section class="dashboard-section">
        <div class="section-header-dash">
          <h2>RECENT SUBMISSIONS</h2>
          <a href="/dashboard/submissions" class="link-brutal">VIEW ALL</a>
        </div>

        {submissions && submissions.length > 0 ? (
          <div class="submissions-table">
            <div class="table-header">
              <span>COMPANY</span>
              <span>STATUS</span>
              <span>DATE</span>
            </div>
            {submissions.map(sub => (
              <div class="table-row">
                <span class="table-company">{sub.company_name}</span>
                <span class={"status-tag status-tag--" + sub.status}>{sub.status.toUpperCase()}</span>
                <span class="table-date">{new Date(sub.created_at).toLocaleDateString()}</span>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-dash">
            <p>NO SUBMISSIONS YET</p>
            <a href="/submit" class="btn-brutal">SUBMIT YOUR FIRST LOGO</a>
          </div>
        )}
      </section>

      <section class="dashboard-section">
        <h2>QUICK ACTIONS</h2>
        <div class="actions-grid">
          <a href="/submit" class="action-card">
            <span class="action-icon">+</span>
            <span class="action-label">SUBMIT LOGO</span>
          </a>
          <a href="/browse" class="action-card">
            <span class="action-icon">O</span>
            <span class="action-label">BROWSE LOGOS</span>
          </a>
          <a href="/docs" class="action-card">
            <span class="action-icon">=</span>
            <span class="action-label">API DOCS</span>
          </a>
        </div>
      </section>
    </main>
  </div>
</Layout>

<script>
  import { createBrowserClient } from '@supabase/ssr';
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  });
</script>
