---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Submit a Logo">
  <!-- SUBMIT HEADER -->
  <section class="submit-header">
    <div class="submit-header__content">
      <span class="tag-brutal tag-brutal--yellow">CONTRIBUTE</span>
      <h1>SUBMIT<br/>A LOGO</h1>
      <p class="submit-header__desc">
        Help grow our library by submitting logos for companies we don't have yet.
        All submissions are reviewed before being published.
      </p>
    </div>
  </section>

  <!-- SUBMIT FORM -->
  <section class="submit-form-section">
    <div class="submit-form-container">
      <form id="submit-form" class="form-brutal">
        <!-- COMPANY INFO -->
        <div class="form-section">
          <div class="form-section__header">
            <span class="form-section__number">01</span>
            <h2>COMPANY INFO</h2>
          </div>

          <div class="form-grid">
            <div class="form-field">
              <label for="company-name" class="label-brutal">
                COMPANY NAME <span class="required">*</span>
              </label>
              <input
                type="text"
                id="company-name"
                name="company_name"
                required
                placeholder="E.G., ACME INC."
                class="input-brutal"
              />
            </div>

            <div class="form-field">
              <label for="company-domain" class="label-brutal">
                COMPANY DOMAIN
              </label>
              <input
                type="text"
                id="company-domain"
                name="company_domain"
                placeholder="E.G., ACME.COM"
                class="input-brutal"
              />
            </div>
          </div>
        </div>

        <!-- FILE UPLOAD -->
        <div class="form-section">
          <div class="form-section__header">
            <span class="form-section__number">02</span>
            <h2>UPLOAD FILES</h2>
          </div>

          <div class="form-field">
            <label class="label-brutal">
              LOGO FILES <span class="required">*</span>
            </label>
            <p class="field-hint">
              UPLOAD SVG AND/OR PNG FILES. SET THE VARIANT TYPE AND COLOR MODE FOR EACH FILE.
            </p>

            <div id="drop-zone" class="dropzone-brutal">
              <div class="dropzone-content">
                <div class="dropzone-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <p class="dropzone-text">
                  DRAG AND DROP FILES HERE
                </p>
                <span class="dropzone-or">OR</span>
                <label for="file-input" class="btn-brutal btn-brutal--outline dropzone-btn">
                  BROWSE FILES
                </label>
                <input
                  type="file"
                  id="file-input"
                  name="files"
                  multiple
                  accept=".svg,.png"
                  class="hidden"
                />
                <p class="dropzone-hint">SVG, PNG UP TO 5MB EACH</p>
              </div>
            </div>

            <div id="file-list" class="file-list-brutal"></div>
          </div>
        </div>

        <!-- LEGAL NOTICE -->
        <div class="notice-brutal notice-brutal--warning">
          <div class="notice-icon">!</div>
          <div class="notice-content">
            <h3>SUBMISSION AGREEMENT</h3>
            <ul>
              <li>YOU HAVE THE RIGHT TO SHARE THIS LOGO</li>
              <li>THE LOGO IS ACCURATE AND UP-TO-DATE</li>
              <li>SUBMISSIONS ARE REVIEWED BEFORE PUBLISHING</li>
            </ul>
          </div>
        </div>

        <!-- AUTH NOTICE -->
        <div id="auth-notice" class="notice-brutal notice-brutal--info">
          <div class="notice-icon">→</div>
          <div class="notice-content">
            <h3>SIGN IN REQUIRED</h3>
            <p>
              YOU NEED TO BE SIGNED IN TO SUBMIT LOGOS.
              <a href="/login" class="link-brutal">SIGN IN HERE</a>
            </p>
          </div>
        </div>

        <!-- SUBMIT BUTTON -->
        <div class="form-actions">
          <button type="submit" id="submit-btn" disabled class="btn-brutal btn-brutal--yellow submit-btn">
            SUBMIT FOR REVIEW →
          </button>
          <span class="form-actions__hint">REVIEW TAKES 24-48 HOURS</span>
        </div>
      </form>

      <!-- SIDEBAR -->
      <aside class="submit-sidebar">
        <div class="sidebar-card">
          <h3>WHAT MAKES A GOOD SUBMISSION?</h3>
          <ul>
            <li>
              <span class="check">+</span>
              HIGH-QUALITY VECTOR (SVG)
            </li>
            <li>
              <span class="check">+</span>
              OFFICIAL COMPANY LOGO
            </li>
            <li>
              <span class="check">+</span>
              TRANSPARENT BACKGROUND
            </li>
            <li>
              <span class="check">+</span>
              CURRENT BRAND VERSION
            </li>
          </ul>
        </div>

        <div class="sidebar-card sidebar-card--dark">
          <h3>NEED HELP?</h3>
          <p>CHECK OUR CONTRIBUTION GUIDELINES FOR BEST PRACTICES.</p>
          <a href="/docs" class="btn-brutal btn-brutal--outline">
            READ GUIDELINES →
          </a>
        </div>
      </aside>
    </div>
  </section>

  <!-- BROWSE CTA -->
  <section class="browse-cta">
    <div class="browse-cta__content">
      <span>LOOKING FOR A SPECIFIC LOGO?</span>
      <a href="/browse" class="btn-brutal">BROWSE EXISTING LOGOS →</a>
    </div>
  </section>
</Layout>

<script>
  import { createBrowserClient } from '@supabase/ssr';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input') as HTMLInputElement;
  const fileList = document.getElementById('file-list');
  const form = document.getElementById('submit-form');
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const authNotice = document.getElementById('auth-notice');

  interface FileWithVariant {
    file: File;
    variantType: string;
    colorMode: string;
    previewUrl?: string;
  }

  let selectedFiles: FileWithVariant[] = [];
  let currentUser: { id: string } | null = null;
  let isSubmitting = false;

  // Helper to get color mode hint text
  function getColorModeHint(mode: string): string {
    const hints: Record<string, string> = {
      'color': '→ Original brand colors',
      'dark': '→ Light logo for dark backgrounds',
      'light': '→ Dark logo for light backgrounds',
      'mono-black': '→ Single color black version',
      'mono-white': '→ Single color white version',
    };
    return hints[mode] || '';
  }

  // Check auth status
  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;

    if (user) {
      authNotice?.classList.add('hidden');
      submitBtn.disabled = false;
    } else {
      authNotice?.classList.remove('hidden');
      submitBtn.disabled = true;
    }
  }

  checkAuth();

  // Drag and drop handling
  dropZone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragging');
  });

  dropZone?.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragging');
  });

  dropZone?.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragging');
    const files = e.dataTransfer?.files;
    if (files) handleFiles(files);
  });

  dropZone?.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).closest('.dropzone-btn')) return;
    fileInput?.click();
  });

  fileInput?.addEventListener('change', () => {
    if (fileInput.files) handleFiles(fileInput.files);
  });

  function handleFiles(files: FileList) {
    for (const file of Array.from(files)) {
      if (file.type === 'image/svg+xml' || file.type === 'image/png') {
        if (file.size <= 5 * 1024 * 1024) {
          const isFirst = selectedFiles.length === 0;
          const fileWithVariant: FileWithVariant = {
            file,
            variantType: isFirst ? 'primary' : 'icon',
            colorMode: 'color',
            previewUrl: URL.createObjectURL(file),
          };
          selectedFiles.push(fileWithVariant);
        } else {
          alert(`${file.name} is too large. Max size is 5MB.`);
        }
      } else {
        alert(`${file.name} is not a valid file type. Only SVG and PNG are allowed.`);
      }
    }
    renderFileList();
  }

  function renderFileList() {
    if (!fileList) return;

    if (selectedFiles.length === 0) {
      fileList.innerHTML = '';
      return;
    }

    fileList.innerHTML = selectedFiles.map((item, index) => `
      <div class="file-item-brutal file-item-brutal--expanded" data-index="${index}">
        <div class="file-item__preview">
          <img src="${item.previewUrl}" alt="${item.file.name}" />
        </div>
        <div class="file-item__details">
          <div class="file-item__header">
            <span class="file-item__type">${item.file.name.split('.').pop()?.toUpperCase()}</span>
            <span class="file-item__name">${item.file.name}</span>
            <span class="file-item__size">${(item.file.size / 1024).toFixed(1)} KB</span>
          </div>
          <div class="file-item__variants">
            <div class="file-item__select">
              <label>TYPE</label>
              <select class="select-brutal select-brutal--small variant-type-select" data-index="${index}">
                <option value="primary" ${item.variantType === 'primary' ? 'selected' : ''}>PRIMARY</option>
                <option value="icon" ${item.variantType === 'icon' ? 'selected' : ''}>ICON</option>
                <option value="wordmark" ${item.variantType === 'wordmark' ? 'selected' : ''}>WORDMARK</option>
                <option value="horizontal" ${item.variantType === 'horizontal' ? 'selected' : ''}>HORIZONTAL</option>
                <option value="stacked" ${item.variantType === 'stacked' ? 'selected' : ''}>STACKED</option>
              </select>
            </div>
            <div class="file-item__select">
              <label>COLOR</label>
              <select class="select-brutal select-brutal--small color-mode-select" data-index="${index}">
                <option value="color" ${item.colorMode === 'color' ? 'selected' : ''}>FULL COLOR</option>
                <option value="dark" ${item.colorMode === 'dark' ? 'selected' : ''}>FOR DARK BG</option>
                <option value="light" ${item.colorMode === 'light' ? 'selected' : ''}>FOR LIGHT BG</option>
                <option value="mono-black" ${item.colorMode === 'mono-black' ? 'selected' : ''}>MONO BLACK</option>
                <option value="mono-white" ${item.colorMode === 'mono-white' ? 'selected' : ''}>MONO WHITE</option>
              </select>
              <span class="color-mode-hint" data-index="${index}">${getColorModeHint(item.colorMode)}</span>
            </div>
          </div>
        </div>
        <button type="button" data-index="${index}" class="file-item__remove">×</button>
      </div>
    `).join('');

    // Attach event listeners for variant selects
    document.querySelectorAll('.variant-type-select').forEach((select) => {
      select.addEventListener('change', (e) => {
        const index = parseInt((e.target as HTMLSelectElement).dataset.index || '0');
        selectedFiles[index].variantType = (e.target as HTMLSelectElement).value;
      });
    });

    document.querySelectorAll('.color-mode-select').forEach((select) => {
      select.addEventListener('change', (e) => {
        const index = parseInt((e.target as HTMLSelectElement).dataset.index || '0');
        const newValue = (e.target as HTMLSelectElement).value;
        selectedFiles[index].colorMode = newValue;
        // Update the hint text
        const hint = document.querySelector(`.color-mode-hint[data-index="${index}"]`);
        if (hint) hint.textContent = getColorModeHint(newValue);
      });
    });

    document.querySelectorAll('.file-item__remove').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt((e.target as HTMLElement).dataset.index || '0');
        if (selectedFiles[index].previewUrl) {
          URL.revokeObjectURL(selectedFiles[index].previewUrl!);
        }
        selectedFiles.splice(index, 1);
        renderFileList();
      });
    });
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (isSubmitting) return;

    if (!currentUser) {
      window.location.href = '/login';
      return;
    }

    if (selectedFiles.length === 0) {
      alert('Please select at least one logo file.');
      return;
    }

    isSubmitting = true;

    const companyName = (document.getElementById('company-name') as HTMLInputElement).value;
    const companyDomain = (document.getElementById('company-domain') as HTMLInputElement).value;

    submitBtn.disabled = true;
    submitBtn.textContent = 'SUBMITTING...';

    try {
      // Create the submission record
      const { data: submission, error: subError } = await supabase
        .from('submissions')
        .insert({
          user_id: currentUser.id,
          company_name: companyName,
          company_domain: companyDomain || null,
        })
        .select()
        .single();

      if (subError) throw subError;

      // Upload files and create file records with per-file variants
      for (const item of selectedFiles) {
        const fileExt = item.file.name.split('.').pop();
        const fileName = `${currentUser.id}/${submission.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

        const { error: uploadError } = await supabase.storage
          .from('submissions')
          .upload(fileName, item.file);

        if (uploadError) throw uploadError;

        const { error: fileError } = await supabase
          .from('submission_files')
          .insert({
            submission_id: submission.id,
            storage_path: fileName,
            format: fileExt,
            variant_type: item.variantType,
            color_mode: item.colorMode,
          });

        if (fileError) throw fileError;
      }

      // Clean up preview URLs
      selectedFiles.forEach(item => {
        if (item.previewUrl) URL.revokeObjectURL(item.previewUrl);
      });

      alert('SUBMISSION SUCCESSFUL! YOUR LOGO WILL BE REVIEWED BY OUR TEAM.');
      window.location.href = '/dashboard/submissions';
    } catch (error) {
      console.error('Submission error:', error);
      alert('FAILED TO SUBMIT. PLEASE TRY AGAIN.');
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'SUBMIT FOR REVIEW →';
    }
  });
</script>
